# P0.3 - DISPATCH PREMIUM G√âN√âRIQUE COMPL√âT√â ‚úÖ

**Date**: 23 d√©cembre 2025  
**Objectif**: Activer le dispatch premium g√©n√©rique pour `/api/v1/exercises/generate`

---

## üéØ R√âSUM√â

L'API publique `/api/v1/exercises/generate` s√©lectionne et appelle automatiquement les g√©n√©rateurs premium enregistr√©s dans `GeneratorFactory` quand `offer=pro`.

---

## üìù MODIFICATIONS

### 1. **backend/routes/exercises_routes.py**

#### Imports ajout√©s
```python
from backend.generators.factory import GeneratorFactory  # P0.3 - Dispatch premium g√©n√©rique
from backend.services.template_renderer import render_template  # P0.3 - Rendu HTML templates
```

#### Dispatch g√©n√©rique (lignes ~1598-1720)

**Ancien code (hardcod√©)**:
```python
if "DUREES_PREMIUM" in chapter_info.exercise_types:
    use_premium = True
    premium_generators = ["DUREES_PREMIUM"]
```

**Nouveau code (g√©n√©rique)**:
```python
# Filtrer les exercise_types pour ne garder que ceux enregistr√©s dans GeneratorFactory
available_factory_generators = list(GeneratorFactory._generators.keys())
factory_generator_keys = [gen_key for gen_key in chapter_info.exercise_types 
                         if gen_key in available_factory_generators]

if factory_generator_keys:
    # S√©lection d√©terministe si seed fourni
    if request.seed is not None:
        generator_index = request.seed % len(factory_generator_keys)
        selected_premium_generator = factory_generator_keys[generator_index]
    else:
        selected_premium_generator = random.choice(factory_generator_keys)
    
    # Appel GeneratorFactory.generate()
    premium_result = GeneratorFactory.generate(
        key=selected_premium_generator,
        exercise_params={},
        overrides={
            'seed': request.seed,
            'grade': request.niveau,
            'difficulty': request.difficulte,
        },
        seed=request.seed
    )
```

#### Rendu HTML avec templates inline

```python
variables = premium_result.get("variables", {})

# Templates coh√©rents avec ChapterExercisesAdminPage.js
enonce_template = """<div class="exercise-enonce">
  <p><strong>{{consigne}}</strong></p>
  <div class="enonce-content" style="white-space: pre-line;">
    {{enonce}}
  </div>
</div>"""

solution_template = """<div class="exercise-solution">
  <h4 style="color: #2563eb; margin-bottom: 1rem;">{{methode}}</h4>
  <div class="calculs" style="background: #f1f5f9; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
    <pre style="white-space: pre-line; font-family: inherit; margin: 0;">{{calculs_intermediaires}}</pre>
  </div>
  <div class="solution-text" style="margin-bottom: 1rem;">
    <p>{{solution}}</p>
  </div>
  <div class="reponse-finale" style="background: #dcfce7; padding: 0.75rem; border-left: 4px solid #22c55e; border-radius: 0.25rem;">
    <p style="margin: 0;"><strong>R√©ponse finale :</strong> {{reponse_finale}}</p>
  </div>
</div>"""

enonce_html = render_template(enonce_template, variables)
solution_html = render_template(solution_template, variables)
```

#### Retour direct sans passer par le flux legacy

```python
return ExerciseGenerateResponse(
    id_exercice=id_exercice,
    niveau=request.niveau,
    chapitre=request.chapitre,
    enonce_html=enonce_html,
    solution_html=solution_html,
    figure_svg=premium_result.get("figure_svg_enonce"),
    figure_svg_enonce=premium_result.get("figure_svg_enonce"),
    figure_svg_solution=premium_result.get("figure_svg_solution"),
    pdf_token=pdf_token,
    metadata={
        "is_premium": True,
        "generator_key": selected_premium_generator,
        "generator_code": f"{request.niveau}_{selected_premium_generator}",
        "difficulte": request.difficulte,
        "generation_duration_ms": duration_ms,
        "seed": request.seed,
        "variables": variables,
    }
)
```

---

### 2. **backend/tests/test_premium_dispatch.py** (CR√â√â)

Tests unitaires couvrant:
- ‚úÖ Dispatch nominal avec g√©n√©rateur Factory
- ‚úÖ Fallback gracieux si pas de g√©n√©rateur Factory
- ‚úÖ D√©terminisme avec seed fixe
- ‚úÖ Fallback sur erreur Factory
- ‚úÖ Respect de `offer=free` (pas de premium)

---

## üß™ VALIDATION

### Test API

```bash
curl -X POST http://localhost:8000/api/v1/exercises/generate \
  -H "Content-Type: application/json" \
  -d '{
    "code_officiel": "6e_SP03",
    "niveau": "6e",
    "chapitre": "Proportionnalit√©",
    "difficulte": "moyen",
    "offer": "pro",
    "seed": 42
  }'
```

**R√©ponse obtenue**:
```json
{
  "id_exercice": "ex_6e_proportionnalit-simple-dans-des-tableaux_1766452338",
  "niveau": "6e",
  "chapitre": "Proportionnalit√© simple dans des tableaux",
  "enonce_html": "<div class=\"exercise-enonce\">...",
  "solution_html": "<div class=\"exercise-solution\">...",
  "metadata": {
    "is_premium": true,
    "generator_key": "RAISONNEMENT_MULTIPLICATIF_V1",
    "generator_code": "6e_RAISONNEMENT_MULTIPLICATIF_V1",
    "difficulte": "moyen",
    "generation_duration_ms": 485,
    "seed": 42
  }
}
```

‚úÖ **R√©sultat**: `enonce_html` et `solution_html` non vides, `is_premium=true`, `generator_key` correct.

---

## ‚úÖ CHECKLIST MANUELLE

- [x] 1. **Dispatch g√©n√©rique**: L'API d√©tecte automatiquement les g√©n√©rateurs Factory dans `chapter_info.exercise_types`
- [x] 2. **D√©terminisme**: Seed fixe ‚Üí m√™me g√©n√©rateur s√©lectionn√© (42 % 2 = 0 ‚Üí `RAISONNEMENT_MULTIPLICATIF_V1`)
- [x] 3. **Rendu HTML**: `enonce_html` et `solution_html` rendus correctement avec `render_template`
- [x] 4. **Metadata premium**: `is_premium=true`, `generator_key` pr√©sent
- [x] 5. **Fallback gracieux**: Si erreur Factory, fallback sur legacy (pas de 500)
- [x] 6. **Respect offer**: `offer=free` ne d√©clenche pas le dispatch Factory

---

## üéØ IMPACT

### Avant
- Dispatch premium hardcod√© pour `DUREES_PREMIUM` uniquement
- Autres g√©n√©rateurs premium (`RAISONNEMENT_MULTIPLICATIF_V1`, `CALCUL_NOMBRES_V1`) ignor√©s par l'API publique

### Apr√®s
- Dispatch g√©n√©rique pour **tous** les g√©n√©rateurs enregistr√©s dans `GeneratorFactory`
- S√©lection d√©terministe si seed fourni
- Templates inline simples et coh√©rents avec le frontend
- Logs observabilit√© complets (`premium_factory_selected`, `premium_factory_success`)

---

## üìä G√âN√âRATEURS PREMIUM ACTIV√âS

| G√©n√©rateur                     | Cl√©                               | Chapitres concern√©s (6e)            |
|-------------------------------|-----------------------------------|-------------------------------------|
| **Raisonnement multiplicatif** | `RAISONNEMENT_MULTIPLICATIF_V1`  | `6e_SP03`, `6e_SP05`, `6e_SP07`    |
| **Calcul nombres**             | `CALCUL_NOMBRES_V1`              | `6e_N04`, `6e_N05`, `6e_N06`, `6e_SP01`, `6e_SP03` |

---

## üîÑ PROCHAINES √âTAPES (HORS SCOPE P0.3)

1. **P1.1 - Variants p√©dagogiques**: Variantes A/B/C pour diversification
2. **P1.2 - Filtrage g√©n√©rateurs**: Emp√™cher s√©lection de g√©n√©rateurs incompatibles dans l'admin
3. **P2.1 - Mapping simplifi√©**: Interface admin pour mapper g√©n√©rateurs ‚Üí chapitres (sans √©diter JSON)

---

## üöÄ D√âPLOIEMENT

```bash
docker compose up -d --build backend
```

Temps de build: ~3s  
Temps de d√©marrage: ~5s

---

**Statut**: ‚úÖ COMPL√âT√â ET VALID√â





