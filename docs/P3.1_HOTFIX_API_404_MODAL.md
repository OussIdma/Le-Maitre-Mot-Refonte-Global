# P3.1 HOTFIX - API 404 + Modal UX

## ðŸ” ProblÃ¨mes identifiÃ©s

### A) API 404 "POST /api/user/sheets"
**Cause** : Le router backend avait le prefix `/user/sheets` mais Ã©tait inclus directement sur `app` au lieu de `api_router` (qui a le prefix `/api`).

**Solution** : Changement du prefix du router Ã  `/api/user/sheets` pour cohÃ©rence avec `/api/user/exercises`.

### B) window.prompt() au lieu de modal UX
**Cause** : Utilisation de `window.prompt()` natif du navigateur, pas cohÃ©rent avec le design shadcn.

**Solution** : Remplacement par une modal shadcn avec Dialog, Input, Textarea, validation UX et i18n.

## âœ… Corrections appliquÃ©es

### 1. Backend - Route API corrigÃ©e

**Fichier** : `backend/routes/user_sheets_routes.py`

**Changement** :
```python
# Avant
router = APIRouter(prefix="/user/sheets", tags=["user_sheets"])

# AprÃ¨s
router = APIRouter(prefix="/api/user/sheets", tags=["user_sheets"])
```

**Justification** : CohÃ©rence avec `/api/user/exercises` dÃ©fini directement dans `server.py` avec `@api_router.post("/user/exercises")` (api_router a prefix `/api`).

### 2. Frontend - Modal shadcn

**Fichier** : `frontend/src/components/MySheetsPageP31.js`

**Changements** :
- âœ… Import `useTranslation`, `Dialog`, `Input`, `Label`, `Textarea`
- âœ… Ã‰tat `showCreateModal`, `newSheetTitle`, `newSheetDescription`
- âœ… Fonction `handleOpenCreateModal()` pour ouvrir la modal
- âœ… Fonction `handleCreateSheet()` avec validation UX (titre requis)
- âœ… Modal avec :
  - Input pour titre (requis, validation)
  - Textarea pour description (optionnel)
  - Boutons Annuler / CrÃ©er
  - Loading state pendant POST
  - Toast succÃ¨s/erreur avec dÃ©tails debug
- âœ… i18n : tous les textes via `t('sheets.*')`

### 3. Frontend - withCredentials ajoutÃ©

**Fichiers** : 
- `frontend/src/components/MySheetsPageP31.js`
- `frontend/src/components/SheetEditPageP31.js`

**Changement** : Ajout de `withCredentials: true` Ã  tous les appels axios pour respecter les cookies httpOnly (P0/P1/P2).

**Exemple** :
```javascript
await axios.post(
  `${API}/user/sheets`,
  { title, description },
  {
    headers: { 'X-Session-Token': sessionToken },
    withCredentials: true  // P0/P1/P2: Cookies httpOnly
  }
);
```

### 4. i18n - Traductions ajoutÃ©es

**Fichier** : `frontend/src/locales/fr.json`

**Ajouts** :
```json
"sheets": {
  "createTitle": "Titre de la fiche",
  "createDescription": "Description (optionnelle)",
  "create": "CrÃ©er",
  "created": "âœ… Fiche crÃ©Ã©e",
  "createdDescription": "Vous pouvez maintenant ajouter des exercices",
  "createError": "Erreur",
  "createErrorDescription": "Impossible de crÃ©er la fiche",
  "titleRequired": "Veuillez saisir un titre pour la fiche",
  "newSheet": "Nouvelle fiche",
  ...
}
```

## ðŸ§ª Validation

### Backend
1. **VÃ©rifier route dans Swagger** :
   - Ouvrir http://localhost:8000/docs
   - Chercher `POST /api/user/sheets`
   - âœ… Route doit exister et Ãªtre accessible

2. **Test curl (non connectÃ© â†’ 401)** :
```bash
curl -X POST http://localhost:8000/api/user/sheets \
  -H "Content-Type: application/json" \
  -d '{"title": "Test", "description": ""}'
# Attendu: 401 Unauthorized
```

3. **Test curl (connectÃ© â†’ 201)** :
```bash
# RÃ©cupÃ©rer le session token depuis localStorage ou cookies
SESSION_TOKEN="votre_token_ici"

curl -X POST http://localhost:8000/api/user/sheets \
  -H "Content-Type: application/json" \
  -H "X-Session-Token: $SESSION_TOKEN" \
  -d '{"title": "Test", "description": ""}'
# Attendu: 201 Created avec sheet_uid
```

### Frontend
1. **Page /mes-fiches** :
   - âœ… Bouton "Nouvelle fiche" ouvre une modal (pas prompt navigateur)
   - âœ… Modal avec Input titre + Textarea description
   - âœ… Validation : message d'erreur si titre vide
   - âœ… Loading state pendant crÃ©ation
   - âœ… Toast succÃ¨s + redirection vers Ã©dition

2. **Network tab** :
   - âœ… POST `/api/user/sheets` retourne 201 (plus de 404)
   - âœ… Headers incluent `X-Session-Token`
   - âœ… `withCredentials: true` prÃ©sent

3. **Console** :
   - âœ… Pas d'erreur 404
   - âœ… En cas d'erreur : logs dÃ©taillÃ©s avec status/response

## ðŸ“‹ Checklist de validation

- [x] Backend : route `/api/user/sheets` accessible dans Swagger
- [x] Backend : test curl non connectÃ© â†’ 401
- [x] Backend : test curl connectÃ© â†’ 201
- [x] Frontend : modal shadcn (pas prompt)
- [x] Frontend : validation UX (titre requis)
- [x] Frontend : loading state
- [x] Frontend : toast succÃ¨s/erreur
- [x] Frontend : i18n complet
- [x] Frontend : withCredentials sur tous les appels
- [x] Frontend : Network tab â†’ plus de 404

## ðŸ”§ Commandes de test

### Test backend - VÃ©rifier route dans Swagger
1. Ouvrir http://localhost:8000/docs
2. Chercher `POST /api/user/sheets` dans la liste des endpoints
3. âœ… Route doit exister et Ãªtre accessible

### Test backend - curl (non connectÃ© â†’ 401)
```bash
curl -X POST http://localhost:8000/api/user/sheets \
  -H "Content-Type: application/json" \
  -d '{"title": "Test", "description": ""}'
# Attendu: 401 Unauthorized
```

### Test backend - curl (connectÃ© â†’ 201)
```bash
# 1. Se connecter via l'interface web
# 2. RÃ©cupÃ©rer le session token depuis localStorage (DevTools > Application > Local Storage > lemaitremot_session_token)
# 3. ExÃ©cuter:

SESSION_TOKEN="votre_token_ici"

curl -X POST http://localhost:8000/api/user/sheets \
  -H "Content-Type: application/json" \
  -H "X-Session-Token: $SESSION_TOKEN" \
  -d '{"title": "Test Fiche", "description": "Description test"}'
# Attendu: 201 Created avec {"sheet_uid": "...", "title": "Test Fiche", ...}
```

### Test frontend
1. Aller sur `/mes-fiches`
2. Cliquer "Nouvelle fiche"
3. âœ… VÃ©rifier que la modal s'ouvre (pas prompt navigateur)
4. Saisir un titre (ex: "ContrÃ´le Fractions")
5. Optionnel : saisir une description
6. Cliquer "CrÃ©er"
7. âœ… VÃ©rifier Network tab : POST `/api/user/sheets` â†’ 201 (plus de 404)
8. âœ… VÃ©rifier redirection vers `/mes-fiches/:sheet_uid`
9. âœ… VÃ©rifier toast succÃ¨s "âœ… Fiche crÃ©Ã©e"

### Test validation UX
1. Ouvrir modal "Nouvelle fiche"
2. Ne rien saisir dans le titre
3. Cliquer "CrÃ©er"
4. âœ… Message d'erreur "Veuillez saisir un titre pour la fiche" sous le champ
5. âœ… Bouton "CrÃ©er" dÃ©sactivÃ© si titre vide

## âœ… RÃ©sultat attendu

- âœ… Plus de 404 sur POST `/api/user/sheets`
- âœ… Modal UX propre (shadcn) au lieu de prompt navigateur
- âœ… Validation UX (titre requis)
- âœ… i18n complet
- âœ… withCredentials pour cookies httpOnly
- âœ… Logs debug en cas d'erreur

