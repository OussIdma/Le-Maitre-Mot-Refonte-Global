# P3.2 - Migration "Pseudo-statique" ‚Üí static_exercises (DB)

## üìã Contexte

Le syst√®me contient des exercices "pseudo-statiques" stock√©s dans des fichiers Python legacy (`gm07_exercises.py`, `gm08_exercises.py`, `tests_dyn_exercises.py`). Ces exercices ne sont pas encore en base de donn√©es MongoDB, donc ils n'apparaissent pas dans l'interface d'administration.

**Objectif** : Migrer ces exercices vers la collection `admin_exercises` avec `is_dynamic=False` pour qu'ils soient visibles et √©ditables dans l'admin.

---

## üéØ Objectif

Cr√©er un script de migration idempotent qui :
1. ‚úÖ D√©tecte tous les exercices legacy/pseudo-statiques existants
2. ‚úÖ Les ins√®re en DB dans `admin_exercises`
3. ‚úÖ √âvite les doublons (hash/uid stable)
4. ‚úÖ Tagge la provenance + verrouille optionnellement

---

## üì¶ Sources Legacy Identifi√©es

### Pattern A : Fichiers Python

Les exercices sont stock√©s dans des fichiers Python avec la structure suivante :

- **`backend/data/gm07_exercises.py`** ‚Üí Chapitre `6E_GM07`
  - 22 exercices fig√©s (Dur√©es et lecture de l'heure)
  - FREE: ids 1-10, PRO: ids 11-20

- **`backend/data/gm08_exercises.py`** ‚Üí Chapitre `6E_GM08`
  - 21 exercices fig√©s (Grandeurs et Mesures)
  - FREE: ids 1-10, PRO: ids 11-20

- **`backend/data/tests_dyn_exercises.py`** ‚Üí Chapitre `6E_TESTS_DYN`
  - Exercices de test dynamiques (peuvent contenir des statiques)

**Structure d'un exercice legacy** :
```python
{
    "id": 1,
    "family": "LECTURE_HORLOGE",
    "difficulty": "facile",
    "offer": "free",
    "enonce_html": "<p>...</p>",
    "solution_html": "<p>...</p>",
    "needs_svg": True,
    "exercise_type": None,
    "is_dynamic": False  # ou absent
}
```

### Pattern B : Curriculum JSON (non impl√©ment√© pour l'instant)

Les fichiers `backend/curriculum/curriculum_6e.json` et `curriculum_5e.json` contiennent la structure des chapitres mais pas les exercices directement. Ils r√©f√©rencent des `exercise_types` qui sont ensuite g√©n√©r√©s dynamiquement.

---

## üîß Utilisation du Script

### Pr√©requis

```bash
# Variables d'environnement requises
export MONGO_URL="mongodb://localhost:27017"
export DB_NAME="le_maitre_mot_db"
```

### Commandes

#### 1. Analyse pr√©alable (rapport d√©taill√©)

Affiche un rapport d√©taill√© sans migration :

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --analyze
```

**Sortie attendue** :
```
================================================================================
üìä ANALYSE PR√âALABLE DES EXERCICES LEGACY
================================================================================

CHAPITRE              | FOUND | DYNAMIC | PSEUDO_STATIC | ALREADY_IN_DB
--------------------------------------------------------------------------------
6e_GM07               |    22 |       0 |            22 |             0
6e_GM08               |    21 |       0 |            21 |             0
6e_TESTS_DYN          |    10 |       5 |             5 |             0
--------------------------------------------------------------------------------
TOTAL                 |    53 |       5 |            48 |             0
================================================================================
```

#### 2. Dry-run (simulation)

Affiche ce qui serait migr√© sans √©crire en DB :

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --dry-run
```

**Sortie attendue** :
```
[INFO] üîç D√©couverte des sources legacy...
[INFO] ‚úÖ Trouv√© 3 fichier(s) Python, 2 fichier(s) JSON
[INFO] üì¶ Chargement des exercices legacy...
[INFO] ‚úÖ 3 chapitre(s) trouv√©(s)

üìö Chapitre: 6E_GM07 (22 exercices)
  üîç [DRY-RUN] UID=abc12345... titre='Lecture simple de l'heure'
  ...

üìä R√âSULTATS
============================================================
‚úÖ Ins√©r√©s: 22
‚è≠Ô∏è  Ignor√©s (d√©j√† existants): 0
‚ùå Erreurs: 0
```

#### 3. Migration compl√®te

Migre tous les chapitres :

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --apply
```

#### 4. Migration d'un seul chapitre

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --apply --chapter 6E_GM07
```

#### 5. Migration avec d√©verrouillage

Par d√©faut, les exercices migr√©s sont `locked=true`. Pour les d√©verrouiller :

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --apply --unlock
```

---

## üîê D√©duplication / UID Stable

Le script calcule un `exercise_uid` stable bas√© sur :
- `chapter_code`
- `enonce_html` (normalis√©: strip + lowercase)
- `solution_html` (normalis√©: strip + lowercase)
- `difficulty`

**Algorithme** :
```python
unique_string = f"{chapter_code}|{normalized_enonce}|{normalized_solution}|{difficulty}"
exercise_uid = sha256(unique_string.encode('utf-8')).hexdigest()
```

**Index MongoDB** :
- Un index unique est cr√©√© sur `exercise_uid` pour garantir l'idempotence.

---

## üìä Mod√®le de Donn√©es Cible

Document MongoDB ins√©r√© dans `admin_exercises` :

```json
{
  "chapter_code": "6E_GM07",
  "id": 1,
  "exercise_uid": "abc123...",
  "title": "Lecture simple de l'heure",
  "difficulty": "facile",
  "offer": "free",
  "enonce_html": "<p>...</p>",
  "solution_html": "<p>...</p>",
  "needs_svg": true,
  "exercise_type": null,
  "family": "LECTURE_HORLOGE",
  "source": "legacy_migration",
  "legacy_ref": "gm07_exercises.py:id=1",
  "locked": true,
  "is_dynamic": false,
  "generator_key": null,
  "needs_solution": false,
  "created_at": "2025-01-23T10:00:00Z",
  "updated_at": "2025-01-23T10:00:00Z"
}
```

**Champs importants** :
- `source: "legacy_migration"` : Tag pour identifier les exercices migr√©s
- `locked: true` : Par d√©faut, les exercices sont verrouill√©s pour √©viter les modifications accidentelles
- `is_dynamic: false` : Forc√© √† `false` pour les exercices statiques
- `exercise_uid` : UID stable pour d√©duplication

---

## ‚úÖ Validation & S√©curit√©

### Validations appliqu√©es

1. **√ânonc√© requis** : `enonce_html` ne doit pas √™tre vide
2. **Solution requise** : `solution_html` ne doit pas √™tre vide
   - Si vide ou contient "√† compl√©ter" ‚Üí `needs_solution=true` et solution par d√©faut ajout√©e
3. **Chapter code requis** : `chapter_code` doit √™tre pr√©sent

### Gestion des erreurs

- Les exercices invalides sont logg√©s et ignor√©s (compt√©s dans `errors`)
- Les erreurs d'insertion MongoDB sont captur√©es et logg√©es
- Le script continue m√™me en cas d'erreur sur un exercice

---

## üîÑ Rollback Simple

Pour supprimer tous les exercices migr√©s :

```javascript
// Dans MongoDB shell ou Compass
db.admin_exercises.deleteMany({ source: "legacy_migration" })
```

Ou via Python :

```python
from motor.motor_asyncio import AsyncIOMotorClient
import os

client = AsyncIOMotorClient(os.environ['MONGO_URL'])
db = client[os.environ['DB_NAME']]
collection = db['admin_exercises']

# Supprimer tous les exercices migr√©s
result = await collection.delete_many({"source": "legacy_migration"})
print(f"Supprim√© {result.deleted_count} exercices")
```

---

## üß™ Tests

### Ex√©cuter les tests

```bash
docker compose exec backend pytest backend/tests/test_migrate_pseudo_static_to_db.py -v
```

### Tests couverts

1. ‚úÖ **Dry-run ne cr√©e rien** : V√©rifie que `--dry-run` ne modifie pas la DB
2. ‚úÖ **Apply cr√©e N exercices** : V√©rifie que `--apply` ins√®re correctement
3. ‚úÖ **Idempotence** : Relancer `--apply` ‚Üí 0 insert, N skip
4. ‚úÖ **UID stable** : M√™mes inputs ‚Üí m√™me `exercise_uid`
5. ‚úÖ **Validation** : Exercices invalides sont rejet√©s
6. ‚úÖ **Needs solution flag** : D√©tection automatique des solutions manquantes

---

## üìù Checklist de Validation Manuelle

### 1. Analyse pr√©alable

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --analyze --chapter 6e_GM07
```

**V√©rifier** :
- ‚úÖ Rapport affich√© avec colonnes FOUND, DYNAMIC, PSEUDO_STATIC, ALREADY_IN_DB
- ‚úÖ Codes de chapitres normalis√©s (format `6e_GM07` et non `6E_GM07`)
- ‚úÖ Aucune erreur fatale

### 2. Dry-run

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --dry-run
```

**V√©rifier** :
- ‚úÖ Aucune erreur fatale
- ‚úÖ Liste des exercices √† migrer affich√©e
- ‚úÖ Statistiques coh√©rentes

### 3. Migration d'un chapitre

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --apply --chapter 6E_GM07
```

**V√©rifier** :
- ‚úÖ `inserted > 0` dans les stats
- ‚úÖ Aucune erreur

### 4. V√©rification UI

1. Aller sur `http://localhost:3000/admin/curriculum/6e_GM07/exercises`
2. Onglet **üìÑ Statiques**
3. ‚úÖ Les exercices migr√©s apparaissent

### 5. Test d'idempotence

```bash
docker compose exec backend python backend/scripts/migrate_pseudo_static_to_db.py --apply --chapter 6E_GM07
```

**Attendu** :
- ‚úÖ `inserted=0`
- ‚úÖ `skipped > 0` (√©gal au nombre d'exercices d√©j√† migr√©s)

---

## üö® Limitations & Notes

### Limitations actuelles

1. **Pattern B (JSON curriculum) non impl√©ment√©** : Seuls les fichiers Python sont support√©s pour l'instant
2. **Pas de migration inverse** : Une fois migr√©, l'exercice n'est plus charg√© depuis le fichier Python (sauf si supprim√© de la DB)

### Notes importantes

- ‚ö†Ô∏è **Ne casse pas le fonctionnement actuel** : La migration ne modifie que la collection `admin_exercises`. Les g√©n√©rateurs dynamiques continuent de fonctionner normalement.
- üîí **Verrouillage par d√©faut** : Les exercices migr√©s sont `locked=true` par d√©faut. Utiliser `--unlock` pour les rendre √©ditables imm√©diatement.
- üìù **Source tracking** : Tous les exercices migr√©s ont `source="legacy_migration"` pour faciliter le tracking et le rollback.

---

## üìö R√©f√©rences

- **Script principal** : `backend/scripts/migrate_pseudo_static_to_db.py`
- **Service loader** : `backend/services/legacy_exercise_loader.py`
- **Tests** : `backend/tests/test_migrate_pseudo_static_to_db.py`
- **Collection MongoDB** : `admin_exercises`
- **Routes admin** : `backend/routes/admin_static_exercises_routes.py`

---

## üîÑ Prochaines √âtapes (Optionnel)

1. **Support Pattern B** : Impl√©menter la migration depuis les fichiers JSON curriculum
2. **Migration inverse** : Permettre de recharger depuis les fichiers Python si besoin
3. **Validation enrichie** : Ajouter des validations p√©dagogiques (longueur √©nonc√©, pr√©sence de formules, etc.)
4. **Migration par batch** : Optimiser pour de tr√®s gros volumes d'exercices

