# P1.3 - CONTRAT G√âN√âRATEUR PREMIUM COMPL√âT√â ‚úÖ

**Date**: 23 d√©cembre 2025  
**Objectif**: Standardiser la cr√©ation des futurs g√©n√©rateurs sans bug ni r√©gression

---

## üéØ R√âSUM√â

Cr√©ation d'un contrat officiel obligatoire pour tous les nouveaux g√©n√©rateurs premium, avec validation automatique par tests.

**Livrables**:
1. ‚úÖ `docs/GENERATOR_PREMIUM_CONTRACT.md` (contrat d√©taill√©, 400 lignes)
2. ‚úÖ `backend/tests/test_generator_contract.py` (tests g√©n√©riques, 12 contrats valid√©s)

---

## üìú 1. CONTRAT OFFICIEL (GENERATOR_PREMIUM_CONTRACT.md)

### Sections du contrat

#### **Section 1: M√©tadonn√©es (GeneratorMeta)**
- `key`, `label`, `description`, `version`, `niveaux`
- `exercise_type`, `svg_mode`, `supports_double_svg`
- ‚ú® P1.2: `is_dynamic`, `supported_grades`, `supported_chapters`

#### **Section 2: Sch√©ma des param√®tres**
- `seed` OBLIGATOIRE (`required=True`)
- `difficulty` avec au moins 2 niveaux
- `grade` coh√©rent avec `meta.niveaux`

#### **Section 3: Gestion du RNG** ‚ö†Ô∏è CRITIQUE
- ‚úÖ UTILISER: `self.rng_randint()`, `self.rng_choice()`, `self.rng_randrange()`
- ‚ùå INTERDIRE: `random.randint()`, `safe_randrange(self._rng, ...)`

#### **Section 4: Variables de sortie obligatoires**
- `enonce`, `consigne`, `solution`, `calculs_intermediaires`
- `reponse_finale`, `niveau`, `type_exercice`
- Optionnel: `methode`, `donnees`, `tableau_html`

#### **Section 5: S√©curit√© HTML** üîí
- `enonce` = texte pur (max `<br>`)
- Tableaux dans `tableau_html` s√©par√© (P0.4)
- Interdiction: `<script>`, `<iframe>`, `javascript:`, etc.

#### **Section 6: Vari√©t√© des √©nonc√©s** (P0.1)
- Pool de formulations: `_ENONCE_VARIANTS`, `_CONSIGNE_VARIANTS`
- Minimum 3 variantes par type d'exercice
- S√©lection d√©terministe via `self.rng_choice()`

#### **Section 7: Compatibilit√© admin**
- Templates HTML dans `ChapterExercisesAdminPage.js`
- Variables : `{{echapp√©}}` vs `{{{HTML brut}}}`

#### **Section 8: Gestion des erreurs**
- `HTTPException` 422 structur√©e
- Codes: `INVALID_DIFFICULTY`, `INVALID_GRADE`, `GENERATION_FAILED`, etc.

#### **Section 9: Tests obligatoires**
- 7 tests minimum par g√©n√©rateur
- Checklist de validation (15 points)

#### **Section 10: Documentation**
- Docstring compl√®te
- Fichier `docs/NOM_GENERATEUR_V1.md`

---

## üß™ 2. TESTS G√âN√âRIQUES (test_generator_contract.py)

### 12 Contrats test√©s automatiquement

| Contrat | Description | Validation |
|---------|-------------|------------|
| 1 | H√©rite de `BaseGenerator` | ‚úÖ Classe valide |
| 2 | `get_meta()` complet | ‚úÖ Toutes les m√©tadonn√©es |
| 3 | `seed` obligatoire | ‚úÖ `required=True` |
| 4 | Variables obligatoires | ‚úÖ 7 variables minimales |
| 5 | D√©terminisme | ‚úÖ seed fixe ‚Üí r√©sultat identique |
| 6 | S√©curit√© HTML | ‚úÖ Pas de `<script>`, `<iframe>` |
| 7 | Vari√©t√© √©nonc√©s | ‚úÖ Au moins 3 variantes |
| 8 | Erreurs 422 structur√©es | ‚úÖ `error_code` pr√©sent |
| 9 | Presets non vide | ‚úÖ Au moins 1 preset |
| 10 | `reponse_finale` string | ‚úÖ Type `str` |
| 11 | Enregistr√© Factory | ‚úÖ Disponible via API |
| 12 | Tous test√©s | ‚úÖ Exhaustivit√© |

### Tests globaux (tous g√©n√©rateurs)

- ‚úÖ Cl√©s uniques
- ‚úÖ Versioning correct (`_V1`, `_V2`)

---

## ‚úÖ 3. VALIDATION DES G√âN√âRATEURS

### G√©n√©rateurs conformes au contrat

| G√©n√©rateur | Tests pass√©s | Statut | Notes |
|-----------|--------------|--------|-------|
| **RAISONNEMENT_MULTIPLICATIF_V1** | 11/11 | ‚úÖ **CONFORME** | G√©n√©rateur de r√©f√©rence |
| **CALCUL_NOMBRES_V1** | 11/11 | ‚úÖ **CONFORME** | Respecte le contrat |

### G√©n√©rateurs hors contrat (anciens)

| G√©n√©rateur | Tests pass√©s | Statut | Action |
|-----------|--------------|--------|--------|
| SIMPLIFICATION_FRACTIONS_V1 | 4/11 | ‚ö†Ô∏è **NON CONFORME** | Refactoring futur |
| SIMPLIFICATION_FRACTIONS_V2 | 4/11 | ‚ö†Ô∏è **NON CONFORME** | Refactoring futur |

**Note**: Les anciens g√©n√©rateurs ne respectent pas encore le contrat (seed non obligatoire, variables manquantes). Ils restent fonctionnels mais ne doivent pas servir de mod√®le.

---

## üìä R√âSULTATS DE VALIDATION

### Commande de validation

```bash
docker compose exec backend pytest backend/tests/test_generator_contract.py -v
```

### R√©sultats pour les g√©n√©rateurs conformes

```
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_1_herite_base_generator[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_2_meta_complete[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_3_schema_seed_obligatoire[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_4_variables_obligatoires[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_5_determinisme[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_6_securite_html_enonce[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_7_variete_enonces[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_8_erreurs_422_structurees[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_9_presets_non_vide[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_10_reponse_finale_string[RAISONNEMENT_MULTIPLICATIF_V1] PASSED
backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_11_enregistre_factory[RAISONNEMENT_MULTIPLICATIF_V1] PASSED

‚úÖ RAISONNEMENT_MULTIPLICATIF_V1: 11/11 PASS√âS
‚úÖ CALCUL_NOMBRES_V1: 11/11 PASS√âS
```

---

## üéØ UTILISATION DU CONTRAT

### Pour cr√©er un nouveau g√©n√©rateur

1. **Lire le contrat**: `docs/GENERATOR_PREMIUM_CONTRACT.md`
2. **Copier un g√©n√©rateur conforme**: `RAISONNEMENT_MULTIPLICATIF_V1` ou `CALCUL_NOMBRES_V1`
3. **Ajouter √† la liste de test**: Modifier `PREMIUM_GENERATORS` dans `test_generator_contract.py`
4. **Ex√©cuter les tests**: `pytest backend/tests/test_generator_contract.py -v`
5. **Corriger jusqu'√† 11/11 tests pass√©s**

### Checklist rapide (15 points)

- [ ] H√©rite de `BaseGenerator`
- [ ] `get_meta()` avec toutes les m√©tadonn√©es
- [ ] `seed` obligatoire dans sch√©ma
- [ ] 7 variables minimales toujours pr√©sentes
- [ ] Utilise `self.rng_*()` pour le RNG
- [ ] Au moins 3 variantes d'√©nonc√©s
- [ ] `enonce` sans HTML complexe
- [ ] Si tableau, utilise `tableau_html` s√©par√©
- [ ] Erreurs 422 avec `error_code`
- [ ] Au moins 1 preset
- [ ] `reponse_finale` est un `str`
- [ ] Enregistr√© dans `factory.py`
- [ ] Template HTML dans admin
- [ ] Documentation cr√©√©e
- [ ] Tests passent (11/11)

---

## üìã ANTI-PATTERNS D√âTECT√âS (√Ä √âVITER)

### ‚ùå 1. RNG mal utilis√©
```python
# INTERDIT
import random
random.randint(1, 10)
safe_randrange(self._rng, 1, 10)  # TypeError !

# CORRECT
self.rng_randint(1, 10)
```

### ‚ùå 2. HTML non s√©curis√©
```python
# INTERDIT
enonce = f"<table>{tableau}</table>"  # Injection possible

# CORRECT
return {
    "enonce": "Compl√®te le tableau :",
    "tableau_html": "<table>...</table>"
}
```

### ‚ùå 3. Variables manquantes
```python
# INTERDIT
return {
    "enonce": "...",
    # Manque consigne, solution, etc.
}

# CORRECT
return {
    "enonce": "...",
    "consigne": "...",
    "solution": "...",
    "calculs_intermediaires": "...",
    "reponse_finale": "...",
    "niveau": "6e",
    "type_exercice": "..."
}
```

### ‚ùå 4. √ânonc√©s fixes
```python
# INTERDIT
enonce = "Calcule 3 + 5"  # Toujours pareil

# CORRECT
_ENONCE_VARIANTS = [
    "Calcule :",
    "Effectue le calcul :",
    "D√©termine le r√©sultat de :"
]
enonce = self.rng_choice(_ENONCE_VARIANTS["type"])
```

### ‚ùå 5. Erreurs non structur√©es
```python
# INTERDIT
raise ValueError("Erreur")

# CORRECT
raise HTTPException(
    status_code=422,
    detail={
        "error_code": "INVALID_DIFFICULTY",
        "message": "Difficult√© invalide",
        "hint": "Difficult√©s valides: facile, moyen",
        "context": {...}
    }
)
```

---

## üöÄ IMPACT ET B√âN√âFICES

### Avant le contrat (SIMPLIFICATION_FRACTIONS_V1/V2)

- ‚ö†Ô∏è Seed optionnel ‚Üí non d√©terministe
- ‚ö†Ô∏è Variables manquantes (`reponse_finale`, `consigne`)
- ‚ö†Ô∏è Pas de vari√©t√© d'√©nonc√©s
- ‚ö†Ô∏è Erreurs non structur√©es
- ‚ö†Ô∏è RNG utilis√© directement

### Apr√®s le contrat (RAISONNEMENT_MULTIPLICATIF_V1, CALCUL_NOMBRES_V1)

- ‚úÖ D√©terminisme garanti (seed obligatoire)
- ‚úÖ Toutes les variables pr√©sentes
- ‚úÖ 3+ variantes d'√©nonc√©s
- ‚úÖ Erreurs 422 structur√©es avec `error_code`
- ‚úÖ RNG s√©curis√© via `self.rng_*()`
- ‚úÖ HTML s√©curis√© (s√©paration `tableau_html`)
- ‚úÖ Validation automatique (11 tests)

---

## üìà M√âTRIQUES DE QUALIT√â

| M√©trique | SIMPLIFICATION_FRACTIONS_V1 | RAISONNEMENT_MULTIPLICATIF_V1 | CALCUL_NOMBRES_V1 |
|----------|------------------------------|-------------------------------|-------------------|
| Tests contrat pass√©s | 4/11 | **11/11** ‚úÖ | **11/11** ‚úÖ |
| D√©terminisme | ‚ö†Ô∏è Non garanti | ‚úÖ 100% | ‚úÖ 100% |
| Variantes √©nonc√©s | 1 | 4 | 4 |
| Variables obligatoires | 3/7 | 7/7 | 7/7 |
| S√©curit√© HTML | ‚ö†Ô∏è Non v√©rifi√© | ‚úÖ Valid√©e | ‚úÖ Valid√©e |
| Erreurs structur√©es | ‚ö†Ô∏è Non | ‚úÖ Oui | ‚úÖ Oui |

---

## üîÑ PROCHAINES √âTAPES

### P1.5 - Refactoring des anciens g√©n√©rateurs
- Mettre √† jour `SIMPLIFICATION_FRACTIONS_V1/V2` pour respecter le contrat
- Cr√©er `SIMPLIFICATION_FRACTIONS_V3` conforme si breaking changes

### P2.1 - √âtendre le contrat
- Ajouter validation des templates HTML (syntaxe Mustache)
- Ajouter validation des SVG (si `svg_mode != "NONE"`)
- Ajouter tests de performance (<100ms par g√©n√©ration)

### P2.2 - Automatisation
- CI/CD: Bloquer le merge si tests contrat √©chouent
- Pre-commit hook: Valider le contrat avant commit

---

## üìù COMMANDES UTILES

### Valider un nouveau g√©n√©rateur

```bash
# Ajouter √† la liste PREMIUM_GENERATORS dans test_generator_contract.py
# Puis ex√©cuter:
docker compose exec backend pytest backend/tests/test_generator_contract.py::TestGeneratorContract -v -k "MON_GENERATEUR_V1"
```

### Valider tous les g√©n√©rateurs conformes

```bash
docker compose exec backend pytest backend/tests/test_generator_contract.py::TestGeneratorContract -v -k "RAISONNEMENT_MULTIPLICATIF_V1 or CALCUL_NOMBRES_V1"
```

### D√©tecter les g√©n√©rateurs non test√©s

```bash
docker compose exec backend pytest backend/tests/test_generator_contract.py::TestGeneratorContract::test_contract_12_tous_generateurs_testes -v
```

### Ex√©cuter manuellement la validation

```bash
cd /app && python3 backend/tests/test_generator_contract.py
```

---

## ‚úÖ CONCLUSION P1.3

**Statut global**: ‚úÖ **COMPL√âT√â ET VALID√â**

- ‚úÖ Contrat officiel cr√©√© (400 lignes, 10 sections)
- ‚úÖ Tests g√©n√©riques cr√©√©s (12 contrats, 2 g√©n√©rateurs valid√©s)
- ‚úÖ Documentation compl√®te
- ‚úÖ 2 g√©n√©rateurs conformes (RAISONNEMENT_MULTIPLICATIF_V1, CALCUL_NOMBRES_V1)
- ‚úÖ Validation automatique fonctionnelle
- ‚úÖ Anti-patterns document√©s

**B√©n√©fice**: Tout nouveau g√©n√©rateur est automatiquement valid√© ou rejet√©. Z√©ro dette technique sur les nouveaux g√©n√©rateurs.

---

**R√®gle d'or**: **Si le test de contrat √©choue, le g√©n√©rateur ne doit PAS √™tre merg√©.**





