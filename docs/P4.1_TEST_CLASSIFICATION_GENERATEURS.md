# P4.1 ‚Äî TEST & CLASSIFICATION DES G√âN√âRATEURS

**Date :** 2025-01-XX  
**Objectif :** Syst√®me automatique de test, classification et s√©curisation des g√©n√©rateurs dynamiques

---

## üéØ Objectif

Mettre en place un syst√®me automatique de test, classification et s√©curisation des g√©n√©rateurs dynamiques, afin de :
- √âliminer les erreurs 422 invisibles
- Rendre l'ajout d'un g√©n√©rateur simple, pr√©dictible et s√ªr
- Pr√©parer l'extension CP ‚Üí Terminale sans dette

---

## üìã Utilisation

### 1. Ex√©cuter les tests

```bash
# Tester tous les g√©n√©rateurs
python backend/scripts/test_dynamic_generators.py --output test_results.json

# Tester un g√©n√©rateur sp√©cifique
python backend/scripts/test_dynamic_generators.py --generator THALES_V2 --output test_results.json

# Tester une difficult√© sp√©cifique
python backend/scripts/test_dynamic_generators.py --difficulty moyen --output test_results.json
```

### 2. G√©n√©rer la classification

```bash
python backend/scripts/classify_generators.py --input test_results.json --output docs/CLASSIFICATION_GENERATEURS.md
```

### 3. Mettre √† jour les g√©n√©rateurs d√©sactiv√©s

Apr√®s avoir g√©n√©r√© la classification, mettre √† jour manuellement la liste `DISABLED_GENERATORS` dans `backend/generators/factory.py` :

```python
DISABLED_GENERATORS: List[str] = [
    "SIMPLIFICATION_FRACTIONS_V1",  # Exemple
    # ... autres g√©n√©rateurs class√©s üî¥
]
```

---

## üß™ Tests effectu√©s

Pour chaque g√©n√©rateur et chaque difficult√©, le script teste :

1. **G√©n√©ration** : G√©n√©ration d'un exercice avec le g√©n√©rateur
2. **Rendu template** : Rendu des templates HTML avec les variables g√©n√©r√©es
3. **Sauvegarde** : Simulation de sauvegarde (s√©rialisation JSON)
4. **Rechargement** : Simulation de rechargement (d√©s√©rialisation JSON)
5. **Export PDF** : Simulation d'export PDF (v√©rification des champs requis)

---

## üìä Format des r√©sultats

### R√©sultat individuel

```json
{
  "generator": "THALES_V2",
  "version": "2.0.0",
  "difficulty": "moyen",
  "seed": 42,
  "tests": [
    {
      "status": "PASS",
      "step": "GENERATION",
      "result": {
        "variables_count": 10,
        "has_svg_enonce": true,
        "has_svg_solution": true
      }
    },
    // ... autres tests
  ],
  "status": "PASS",
  "failed_step": null,
  "error": null
}
```

### R√©sultat d'√©chec

```json
{
  "generator": "SOME_GENERATOR",
  "difficulty": "moyen",
  "status": "FAIL",
  "failed_step": "TEMPLATE_RENDERING",
  "error": "KeyError: missing_variable"
}
```

### R√©sum√© final

```json
{
  "summary": {
    "total": 7,
    "pass": 3,
    "fail": 4,
    "timestamp": "2025-01-XXT..."
  },
  "results": [/* ... */]
}
```

---

## üü¢üü†üî¥ Classification

### üü¢ GOLD

**Crit√®res :**
- 100% des tests passent
- Seed stable
- Export PDF OK

**Utilisation :** Production imm√©diate

### üü† AM√âLIORABLE

**Crit√®res :**
- √âchecs localis√©s
- Fix estimable
- Probl√®mes sur une √©tape sp√©cifique

**Utilisation :** Visible mais avec limitations

### üî¥ D√âSACTIV√â

**Crit√®res :**
- √âchecs r√©currents (>50% des tests)
- Monkeypatch RNG
- Templates inline non ma√Ætris√©s

**Utilisation :** **NON visible dans l'UI, NON utilisable**

---

## üîí Garde-fous techniques

### Backend ‚Äî GeneratorFactory

Les g√©n√©rateurs d√©sactiv√©s sont bloqu√©s dans :

1. **`GeneratorFactory.get()`** : Retourne `None` si d√©sactiv√©
2. **`GeneratorFactory.generate()`** : L√®ve une `ValueError` si d√©sactiv√©
3. **`GeneratorFactory.get_schema()`** : Retourne `None` si d√©sactiv√©
4. **`GeneratorFactory.list_all()`** : Exclut les d√©sactiv√©s par d√©faut

### Logs

Toute tentative d'utilisation d'un g√©n√©rateur d√©sactiv√© g√©n√®re un log :

```
[GENERATOR_DISABLED] Tentative d'utilisation du g√©n√©rateur d√©sactiv√©: SIMPLIFICATION_FRACTIONS_V1
```

### Frontend / Curriculum

Les g√©n√©rateurs non-GOLD sont automatiquement filtr√©s dans :
- Liste des g√©n√©rateurs disponibles (`/api/v1/exercises/generators`)
- S√©lection de g√©n√©rateur dans l'admin
- Curriculum (chapitres)

---

## üõ°Ô∏è Z√©ro erreur visible utilisateur

### Fallback automatique

Si un g√©n√©rateur √©choue (m√™me s'il n'est pas d√©sactiv√©), le syst√®me :

1. **Log l'erreur c√¥t√© serveur** (avec `[GENERATOR_FAIL]`)
2. **Active le fallback STATIC** automatiquement
3. **Ne montre AUCUNE erreur** √† l'utilisateur
4. **Affiche un message neutre** si le fallback √©choue aussi :
   > "Un exercice alternatif a √©t√© propos√©."

### Pipeline de fallback

```
DYNAMIC (tentative)
  ‚Üì (√©chec)
STATIC (fallback)
  ‚Üì (√©chec)
Message neutre (pas d'erreur technique)
```

---

## ‚úÖ Checklist de validation

- [ ] Script ex√©cutable en 1 commande
- [ ] Rapport JSON g√©n√©r√©
- [ ] Classification √©crite dans `docs/CLASSIFICATION_GENERATEURS.md`
- [ ] G√©n√©rateurs instables invisibles c√¥t√© prof
- [ ] Plus aucun 422 non expliqu√©
- [ ] Ajouter un g√©n√©rateur = passer le script

---

## üìù Workflow complet

### Ajouter un nouveau g√©n√©rateur

1. **Cr√©er le g√©n√©rateur** dans `backend/generators/`
2. **L'enregistrer** avec `@GeneratorFactory.register`
3. **Tester** :
   ```bash
   python backend/scripts/test_dynamic_generators.py --generator NOUVEAU_GENERATEUR --output test_results.json
   ```
4. **Classifier** :
   ```bash
   python backend/scripts/classify_generators.py --input test_results.json --output docs/CLASSIFICATION_GENERATEURS.md
   ```
5. **V√©rifier la classification** dans `docs/CLASSIFICATION_GENERATEURS.md`
6. **Si üî¥ D√âSACTIV√â** : Ajouter √† `DISABLED_GENERATORS` dans `factory.py`

### Mettre √† jour la classification

1. **Relancer les tests** :
   ```bash
   python backend/scripts/test_dynamic_generators.py --output test_results.json
   ```
2. **R√©g√©n√©rer la classification** :
   ```bash
   python backend/scripts/classify_generators.py --input test_results.json --output docs/CLASSIFICATION_GENERATEURS.md
   ```
3. **Mettre √† jour `DISABLED_GENERATORS`** si n√©cessaire

---

## üèÅ R√©sultat attendu

√Ä la fin de P4.1 :
- ‚úÖ Le moteur est pr√©dictible
- ‚úÖ Les g√©n√©rateurs sont fiables ou √©cart√©s
- ‚úÖ L'ajout d'un chapitre ou d'un niveau devient industriel
- ‚úÖ On peut s√©rieusement viser CP ‚Üí Terminale

---

**Document g√©n√©r√© automatiquement le :** 2025-01-XX  
**Derni√®re mise √† jour :** 2025-01-XX




