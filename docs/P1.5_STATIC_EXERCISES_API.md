# P1.5 - API Admin Exercices Statiques ‚úÖ

**Date :** 2025-12-23  
**Statut :** ‚úÖ **COMPL√âT√â (Partie 2/3)**

---

## üéØ Objectif

Rendre les **exercices statiques** (fig√©s) visibles et √©ditables depuis l'admin, sans impacter les exercices dynamiques.

### D√©finition

**Exercice statique** = Exercice stock√© en DB avec contenu `enonce_html`/`solution_html` d√©j√† √©crits.

**Caract√©ristiques :**
- `is_dynamic = False` (ou absent)
- `generator_key` absent ou `null`
- Contenu HTML fig√© (pas de variables/placeholders)

---

## üì¶ Endpoints Cr√©√©s

### Base URL
```
/api/v1/admin
```

---

### 1. **GET** `/chapters/{code_officiel}/static-exercises`

Liste tous les exercices statiques d'un chapitre.

#### Param√®tres
- **`code_officiel`** (path) : Code du chapitre (ex: `6e_GM07`)

#### R√©ponse 200
```json
[
  {
    "id": 1,
    "chapter_code": "6e_GM07",
    "title": "Lecture de l'heure - 8h30",
    "difficulty": "facile",
    "enonce_html": "<p>Quelle heure indique l'horloge ?</p>",
    "solution_html": "<p><strong>R√©ponse :</strong> 8h30</p>",
    "tags": ["horloge", "lecture"],
    "order": 1,
    "exercise_type": "LECTURE_HEURE",
    "offer": "free",
    "updated_at": "2025-12-23T10:30:00Z"
  }
]
```

#### Filtrage
- **Inclus :** `is_dynamic=False` ET `generator_key` absent/null
- **Exclus :** Exercices dynamiques
- **Tri :** Par `order` (croissant), puis `id`

#### Erreurs
- **500** : Erreur serveur

---

### 2. **PUT** `/static-exercises/{exercise_id}`

Met √† jour un exercice statique.

#### Param√®tres
- **`exercise_id`** (path) : ID de l'exercice

#### Body (tous les champs optionnels)
```json
{
  "title": "Nouveau titre",
  "difficulty": "moyen",
  "enonce_html": "<p>√ânonc√© modifi√©...</p>",
  "solution_html": "<p>Solution modifi√©e...</p>",
  "tags": ["tag1", "tag2"],
  "order": 5,
  "exercise_type": "TYPE",
  "offer": "free"
}
```

#### Validation
- **`difficulty`** : `"facile"` | `"moyen"` | `"difficile"`
- **`offer`** : `"free"` | `"pro"`
- **`enonce_html`** : Max 10 000 caract√®res
- **`solution_html`** : Max 10 000 caract√®res
- **`title`** : Max 200 caract√®res

#### R√©ponse 200
```json
{
  "id": 1,
  "chapter_code": "6e_GM07",
  "title": "Nouveau titre",
  "difficulty": "moyen",
  ...
}
```

#### Erreurs
- **400** : Tentative de modification d'un exercice dynamique
  ```json
  {
    "detail": {
      "error_code": "CANNOT_UPDATE_DYNAMIC_VIA_STATIC_ENDPOINT",
      "message": "L'exercice 2 est dynamique. Utilisez l'endpoint d√©di√©.",
      "is_dynamic": true,
      "generator_key": "LECTURE_HORLOGE",
      "hint": "Utilisez /api/v1/admin/exercises/{id} pour modifier les exercices dynamiques"
    }
  }
  ```
- **404** : Exercice introuvable
- **422** : Donn√©es invalides

---

### 3. **POST** `/chapters/{code_officiel}/static-exercises` ‚úÖ

Cr√©e un nouvel exercice statique dans un chapitre.

#### Param√®tres
- **`code_officiel`** (path) : Code du chapitre (ex: `6e_GM07`)

#### Body (tous les champs optionnels sauf enonce/solution)
```json
{
  "title": "Nouveau probl√®me de dur√©es",
  "difficulty": "moyen",
  "enonce_html": "<p>√ânonc√© du probl√®me...</p>",
  "solution_html": "<p>Solution du probl√®me...</p>",
  "tags": ["durees", "probleme"],
  "order": 10,
  "exercise_type": "PROBLEME_DUREES",
  "offer": "free"
}
```

#### Valeurs par d√©faut
- `difficulty`: `"facile"`
- `enonce_html`: `"<p>√ânonc√© √† compl√©ter...</p>"`
- `solution_html`: `"<p>Solution √† compl√©ter...</p>"`
- `offer`: `"free"`
- `tags`: `[]`
- `is_dynamic`: `False` (forc√©)

#### R√©ponse 201
```json
{
  "id": 4,
  "chapter_code": "6e_GM08",
  "title": "Nouveau probl√®me de dur√©es",
  "difficulty": "moyen",
  ...
}
```

#### Erreurs
- **422** : Donn√©es invalides

---

### 4. **DELETE** `/static-exercises/{exercise_id}` ‚úÖ

Supprime un exercice statique.

#### Param√®tres
- **`exercise_id`** (path) : ID de l'exercice

#### R√©ponse 204
Pas de contenu (succ√®s)

#### Erreurs
- **400** : Tentative de suppression d'un exercice dynamique
- **404** : Exercice introuvable

---

## üîí S√©curit√©

### Protection des Exercices Dynamiques

Les endpoints **refusent strictement** toute op√©ration (UPDATE, DELETE) sur un exercice dynamique :

```json
{
  "error_code": "CANNOT_UPDATE_DYNAMIC_VIA_STATIC_ENDPOINT",
  "message": "L'exercice X est dynamique. Utilisez l'endpoint d√©di√©.",
  "is_dynamic": true,
  "generator_key": "GENERATOR_KEY"
}
```

**Rationnel :** 
- √âviter la corruption de donn√©es
- S√©parer clairement les workflows statiques vs dynamiques
- Pr√©venir les erreurs utilisateur

---

## üß™ Tests

### Fichier
`backend/tests/test_admin_static_exercises.py`

### Coverage

| Test | Description | Statut |
|------|-------------|--------|
| `test_list_static_by_chapter` | Liste exercices statiques | ‚úÖ |
| `test_list_static_empty_chapter` | Chapitre vide ‚Üí liste vide | ‚úÖ |
| `test_update_static_success` | Mise √† jour r√©ussie | ‚úÖ |
| `test_update_static_not_found` | Exercice inexistant ‚Üí 404 | ‚úÖ |
| `test_cannot_update_dynamic_via_static_endpoint` | ‚ö†Ô∏è **CRITIQUE** : Refus modification dynamique | ‚úÖ |
| `test_update_static_invalid_difficulty` | Validation difficult√© ‚Üí 422 | ‚úÖ |
| `test_update_static_invalid_offer` | Validation offre ‚Üí 422 | ‚úÖ |
| `test_create_static_success` | Cr√©ation r√©ussie ‚Üí 201 | ‚úÖ |
| `test_create_static_minimal` | Cr√©ation avec valeurs par d√©faut | ‚úÖ |
| `test_create_static_invalid_difficulty` | Validation cr√©ation ‚Üí 422 | ‚úÖ |
| `test_delete_static_success` | Suppression r√©ussie ‚Üí 204 | ‚úÖ |
| `test_delete_static_not_found` | Exercice inexistant ‚Üí 404 | ‚úÖ |
| `test_cannot_delete_dynamic_via_static_endpoint` | ‚ö†Ô∏è **CRITIQUE** : Refus suppression dynamique | ‚úÖ |
| `test_static_exercises_preserved_after_operations` | Non-r√©gression | ‚úÖ |

**Total :** 14 tests | **Statut :** ‚úÖ Tous PASS

---

## üìä Architecture

### Mod√®le de Donn√©es (R√©utilis√©)

**Collection MongoDB :** `admin_exercises`

**Sch√©ma (extraits pertinents) :**

```python
{
  "id": int,                      # ID unique
  "chapter_code": str,            # Code chapitre (ex: 6e_GM07)
  "title": Optional[str],         # Titre
  "difficulty": str,              # facile | moyen | difficile
  "enonce_html": str,             # √ânonc√© HTML (requis si statique)
  "solution_html": str,           # Solution HTML (requis si statique)
  "tags": List[str],              # Tags optionnels
  "order": Optional[int],         # Ordre d'affichage
  "exercise_type": Optional[str], # Type d'exercice
  "offer": str,                   # free | pro
  "is_dynamic": bool,             # False pour statiques
  "generator_key": Optional[str], # null pour statiques
  "created_at": datetime,
  "updated_at": datetime
}
```

### Service R√©utilis√©

**Service :** `ExercisePersistenceService`  
**Fichier :** `backend/services/exercise_persistence_service.py`

**M√©thodes utilis√©es :**
- `get_all_by_chapter(chapter_code)` : Liste exercices d'un chapitre
- `get_by_id(exercise_id)` : R√©cup√®re un exercice
- `update(exercise_id, data)` : Met √† jour un exercice
- `create(exercise_dict)` : Cr√©e un exercice
- `delete(exercise_id)` : Supprime un exercice

---

## üîÑ Filtrage Statiques vs Dynamiques

### Logique de Filtrage

```python
# Un exercice est STATIQUE si:
is_static = (
    not exercise.get("is_dynamic", False) 
    and not exercise.get("generator_key")
)

# Un exercice est DYNAMIQUE si:
is_dynamic = (
    exercise.get("is_dynamic") == True 
    or exercise.get("generator_key") is not None
)
```

### Tri des R√©sultats

```python
# Tri par order (croissant), puis par id
exercises.sort(key=lambda ex: (ex.get("order") or 999999, ex.get("id", 0)))
```

**Rationnel :**
- `order` permet un tri personnalis√© par l'admin
- `999999` : Si `order` absent ‚Üí plac√© en fin de liste
- `id` : Ordre stable pour exercices sans `order`

---

## üöÄ Int√©gration

### Dans `server.py`

```python
# Routes admin exercices statiques (P1.5 - Partie 2/3)
from backend.routes.admin_static_exercises_routes import router as admin_static_exercises_router
app.include_router(admin_static_exercises_router, tags=["Admin Static Exercises"])
```

### Documentation Swagger

**URL :** http://localhost:8000/docs

**Tag :** `Admin Static Exercises`

---

## üìù Exemples d'Utilisation

### Lister les exercices statiques d'un chapitre

```bash
curl -X GET "http://localhost:8000/api/v1/admin/chapters/6e_GM07/static-exercises"
```

### Modifier un exercice statique

```bash
curl -X PUT "http://localhost:8000/api/v1/admin/static-exercises/1" \
  -H "Content-Type: application/json" \
  -d '{
    "enonce_html": "<p>√ânonc√© modifi√©</p>",
    "solution_html": "<p>Solution modifi√©e</p>",
    "tags": ["nouveau", "tag"]
  }'
```

### Cr√©er un nouvel exercice statique

```bash
curl -X POST "http://localhost:8000/api/v1/admin/chapters/6e_GM08/static-exercises" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Nouveau probl√®me",
    "difficulty": "moyen",
    "enonce_html": "<p>√ânonc√©...</p>",
    "solution_html": "<p>Solution...</p>"
  }'
```

### Supprimer un exercice statique

```bash
curl -X DELETE "http://localhost:8000/api/v1/admin/static-exercises/1"
```

---

## ‚ö†Ô∏è Contraintes Respect√©es

- ‚úÖ **Mod√®le existant r√©utilis√©** : Aucune modification du sch√©ma MongoDB
- ‚úÖ **Endpoints publics intacts** : Aucune r√©gression
- ‚úÖ **S√©paration statiques/dynamiques** : Filtrage strict via `is_dynamic`
- ‚úÖ **Erreurs propres** : 404, 422, 400 avec `error_code` + `message` + `hint`
- ‚úÖ **Tests obligatoires** : 14 tests passants

---

## üéâ Livrables

| Livrable | Fichier | Statut |
|----------|---------|--------|
| Routes backend | `backend/routes/admin_static_exercises_routes.py` | ‚úÖ |
| Tests | `backend/tests/test_admin_static_exercises.py` | ‚úÖ |
| Documentation | `docs/P1.5_STATIC_EXERCISES_API.md` | ‚úÖ |
| Int√©gration | `backend/server.py` | ‚úÖ |

---

## üöÄ Prochaines √âtapes (P1.5 - Partie 3/3)

### UI Admin : Onglets Statiques/Dynamiques

**Objectif :** Cr√©er une interface admin avec 2 onglets distincts :

1. **"Dynamiques (g√©n√©r√©s)"** 
   - Liste des g√©n√©rateurs
   - Bouton "R√©daction templates"
   - Badge üß© Dynamique

2. **"Statiques (fig√©s)"**
   - Liste des exercices statiques (consomme les endpoints cr√©√©s ici)
   - √âdition en ligne : `enonce_html`, `solution_html`, `tags`, `order`
   - Badge üìÑ Statique

**Fichiers concern√©s :**
- `frontend/src/components/admin/ChapterExercisesAdminPage.js`

**Endpoints consomm√©s :**
- `GET /api/v1/admin/chapters/{code}/static-exercises`
- `PUT /api/v1/admin/static-exercises/{id}`
- `POST /api/v1/admin/chapters/{code}/static-exercises`
- `DELETE /api/v1/admin/static-exercises/{id}`

---

**Date de livraison :** 2025-12-23  
**Temps pass√© :** ~2h  
**Statut Final :** ‚úÖ **PARTIE 2/3 COMPL√àTE**





