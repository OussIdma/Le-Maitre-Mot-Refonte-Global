# P1.2 - PLAN D'IMPLÃ‰MENTATION : FILTRAGE & AJOUT GUIDÃ‰

**Date**: 23 dÃ©cembre 2025  
**Objectif**: Ã‰viter les erreurs de sÃ©lection + permettre l'ajout de gÃ©nÃ©rateurs sans modifier le JSON

---

## ğŸ¯ OBJECTIFS

1. **Filtrer automatiquement** les gÃ©nÃ©rateurs incompatibles avec un chapitre (par grade)
2. **Permettre l'ajout** d'un gÃ©nÃ©rateur Ã  un chapitre via UI (sans modifier curriculum JSON)
3. **PrÃ©venir les erreurs** "chapitre incompatible" avant la sÃ©lection
4. **Garder l'UI simple** : par dÃ©faut = gÃ©nÃ©rateurs compatibles, "Plus de choix" = tous

---

## ğŸ“¦ ARCHITECTURE

### 1. Backend - API Metadata (`/api/v1/exercises/generators`)

**Objectif**: Exposer les mÃ©tadonnÃ©es de chaque gÃ©nÃ©rateur pour le filtrage frontend

**Modifications**:
```python
# backend/routes/exercises_routes.py

@router.get("/generators", ...)
async def list_generators():
    """
    Liste tous les gÃ©nÃ©rateurs avec leurs mÃ©tadonnÃ©es complÃ¨tes.
    
    Returns:
        {
            "generators": [
                {
                    "key": "RAISONNEMENT_MULTIPLICATIF_V1",
                    "label": "Raisonnement multiplicatif (PREMIUM)",
                    "description": "...",
                    "version": "1.0.0",
                    "is_dynamic": true,
                    "supported_grades": ["6e", "5e"],
                    "supported_chapters": ["6e_SP01", "6e_SP03", ...],
                    "exercise_type": "RAISONNEMENT_MULTIPLICATIF",
                    "tags": ["proportionnalitÃ©", "pourcentage", "premium"]
                },
                ...
            ]
        }
    """
    generators = []
    
    for gen_key, gen_class in GeneratorFactory._generators.items():
        meta = gen_class.get_meta()
        
        # Extraction des mÃ©tadonnÃ©es pour filtrage
        generator_info = {
            "key": meta.key,
            "label": meta.label,
            "description": meta.description,
            "version": meta.version,
            "is_dynamic": getattr(meta, 'is_dynamic', True),  # Fallback pour legacy
            "supported_grades": getattr(meta, 'supported_grades', meta.niveaux),
            "supported_chapters": getattr(meta, 'supported_chapters', []),
            "exercise_type": meta.exercise_type,
            "niveaux": meta.niveaux,
            "svg_mode": meta.svg_mode,
            "tags": _extract_tags_from_meta(meta)  # Helper pour extraire tags
        }
        
        generators.append(generator_info)
    
    return {"generators": generators}

def _extract_tags_from_meta(meta: GeneratorMeta) -> list:
    """Extrait des tags pertinents depuis les mÃ©tadonnÃ©es."""
    tags = []
    
    # Tag "premium" si gÃ©nÃ©rateur premium
    if "premium" in meta.label.lower():
        tags.append("premium")
    
    # Tags depuis exercise_type
    if "RAISONNEMENT" in meta.exercise_type:
        tags.append("raisonnement")
    if "CALCUL" in meta.exercise_type:
        tags.append("calcul")
    if "FRACTION" in meta.exercise_type:
        tags.append("fractions")
    if "PROPORTIONNALITE" in meta.exercise_type or "PROPORTIONNAL" in meta.exercise_type:
        tags.append("proportionnalitÃ©")
    
    return tags
```

---

### 2. Backend - Collection MongoDB pour associations

**Objectif**: Stocker les associations chapitre â†” gÃ©nÃ©rateur ajoutÃ©es via l'admin

**Schema**:
```python
# backend/models/chapter_generator_association.py (CRÃ‰ER)

from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime

class ChapterGeneratorAssociation(BaseModel):
    """
    Association entre un chapitre et un gÃ©nÃ©rateur ajoutÃ©e via l'admin.
    
    StockÃ© en DB pour surcharger le curriculum JSON.
    """
    id: Optional[str] = Field(None, alias="_id")
    code_officiel: str = Field(..., description="Code du chapitre (ex: 6e_SP03)")
    generator_key: str = Field(..., description="ClÃ© du gÃ©nÃ©rateur (ex: CALCUL_NOMBRES_V1)")
    added_by: Optional[str] = Field(None, description="Email de l'admin qui a ajoutÃ©")
    added_at: datetime = Field(default_factory=datetime.utcnow)
    is_active: bool = Field(True, description="Permet de dÃ©sactiver sans supprimer")
    
    class Config:
        populate_by_name = True
```

**Collection MongoDB**: `chapter_generator_associations`

---

### 3. Backend - Endpoints d'association admin

**Fichier**: `backend/routes/admin_routes.py` (CRÃ‰ER ou Ã‰TENDRE)

```python
# backend/routes/admin_routes.py

from fastapi import APIRouter, HTTPException, Depends
from backend.models.chapter_generator_association import ChapterGeneratorAssociation
from backend.generators.factory import GeneratorFactory
from backend.database import get_database
from typing import List

router = APIRouter(prefix="/api/v1/admin", tags=["admin"])

# ============================================================================
# POST - Ajouter un gÃ©nÃ©rateur Ã  un chapitre
# ============================================================================

@router.post("/chapters/{code_officiel}/generators")
async def add_generator_to_chapter(
    code_officiel: str,
    request: dict,  # {"generator_key": "CALCUL_NOMBRES_V1"}
    # admin_user = Depends(get_current_admin_user)  # Ã€ implÃ©menter
):
    """
    Associe un gÃ©nÃ©rateur Ã  un chapitre.
    
    L'association est stockÃ©e en DB et fusionne avec le curriculum JSON.
    """
    generator_key = request.get("generator_key")
    
    if not generator_key:
        raise HTTPException(400, "generator_key requis")
    
    # VÃ©rifier que le gÃ©nÃ©rateur existe
    gen_class = GeneratorFactory.get(generator_key)
    if not gen_class:
        raise HTTPException(404, f"GÃ©nÃ©rateur {generator_key} introuvable")
    
    # VÃ©rifier compatibilitÃ© (optionnel mais recommandÃ©)
    meta = gen_class.get_meta()
    chapter_grade = code_officiel.split("_")[0]  # Ex: "6e" depuis "6e_SP03"
    
    supported_grades = getattr(meta, 'supported_grades', meta.niveaux)
    if chapter_grade not in supported_grades:
        # Warning mais on autorise (admin peut forcer)
        print(f"âš ï¸ Warning: {generator_key} n'est pas officiellement compatible avec {chapter_grade}")
    
    # CrÃ©er l'association
    db = await get_database()
    collection = db["chapter_generator_associations"]
    
    # VÃ©rifier si dÃ©jÃ  existante
    existing = await collection.find_one({
        "code_officiel": code_officiel,
        "generator_key": generator_key
    })
    
    if existing:
        # RÃ©activer si dÃ©sactivÃ©e
        if not existing.get("is_active", True):
            await collection.update_one(
                {"_id": existing["_id"]},
                {"$set": {"is_active": True}}
            )
            return {"message": "Association rÃ©activÃ©e", "code_officiel": code_officiel, "generator_key": generator_key}
        else:
            raise HTTPException(409, "Association dÃ©jÃ  existante")
    
    # CrÃ©er nouvelle association
    association = ChapterGeneratorAssociation(
        code_officiel=code_officiel,
        generator_key=generator_key,
        added_by="admin@example.com",  # Ã€ remplacer par admin_user.email
        is_active=True
    )
    
    result = await collection.insert_one(association.dict(by_alias=True))
    
    return {
        "message": "GÃ©nÃ©rateur ajoutÃ© au chapitre",
        "code_officiel": code_officiel,
        "generator_key": generator_key,
        "association_id": str(result.inserted_id)
    }

# ============================================================================
# DELETE - Retirer un gÃ©nÃ©rateur d'un chapitre
# ============================================================================

@router.delete("/chapters/{code_officiel}/generators/{generator_key}")
async def remove_generator_from_chapter(
    code_officiel: str,
    generator_key: str,
    # admin_user = Depends(get_current_admin_user)
):
    """
    Retire l'association entre un chapitre et un gÃ©nÃ©rateur.
    
    Soft delete : marque is_active=False au lieu de supprimer.
    """
    db = await get_database()
    collection = db["chapter_generator_associations"]
    
    # Trouver l'association
    association = await collection.find_one({
        "code_officiel": code_officiel,
        "generator_key": generator_key
    })
    
    if not association:
        raise HTTPException(404, "Association introuvable")
    
    # Soft delete
    await collection.update_one(
        {"_id": association["_id"]},
        {"$set": {"is_active": False}}
    )
    
    return {
        "message": "GÃ©nÃ©rateur retirÃ© du chapitre",
        "code_officiel": code_officiel,
        "generator_key": generator_key
    }

# ============================================================================
# GET - Lister les associations d'un chapitre
# ============================================================================

@router.get("/chapters/{code_officiel}/generators")
async def list_chapter_generators(code_officiel: str):
    """
    Liste tous les gÃ©nÃ©rateurs associÃ©s Ã  un chapitre.
    
    Fusionne :
    - curriculum JSON (dÃ©faut)
    - associations DB (ajouts admin)
    """
    # 1. RÃ©cupÃ©rer les gÃ©nÃ©rateurs du curriculum JSON
    from backend.curriculum.loader import get_chapter_by_official_code
    
    chapter_info = get_chapter_by_official_code(code_officiel)
    json_generators = chapter_info.exercise_types if chapter_info else []
    
    # 2. RÃ©cupÃ©rer les associations DB
    db = await get_database()
    collection = db["chapter_generator_associations"]
    
    db_associations = await collection.find({
        "code_officiel": code_officiel,
        "is_active": True
    }).to_list(length=100)
    
    db_generators = [assoc["generator_key"] for assoc in db_associations]
    
    # 3. Fusionner (union sans doublons)
    all_generators = list(set(json_generators + db_generators))
    
    # 4. Enrichir avec mÃ©tadonnÃ©es
    generators_info = []
    for gen_key in all_generators:
        gen_class = GeneratorFactory.get(gen_key)
        if not gen_class:
            continue
        
        meta = gen_class.get_meta()
        
        generators_info.append({
            "key": gen_key,
            "label": meta.label,
            "source": "json" if gen_key in json_generators else "db",
            "is_dynamic": getattr(meta, 'is_dynamic', True),
            "supported_grades": getattr(meta, 'supported_grades', meta.niveaux)
        })
    
    return {
        "code_officiel": code_officiel,
        "generators": generators_info,
        "total": len(generators_info)
    }
```

---

### 4. Backend - Fusion JSON + DB lors de la gÃ©nÃ©ration

**Objectif**: Lors de `/api/v1/exercises/generate`, utiliser les gÃ©nÃ©rateurs fusionnÃ©s (JSON + DB)

**Modifications**:
```python
# backend/routes/exercises_routes.py

async def _get_merged_chapter_generators(code_officiel: str) -> List[str]:
    """
    RÃ©cupÃ¨re les gÃ©nÃ©rateurs d'un chapitre en fusionnant JSON + DB.
    
    Returns:
        Liste des clÃ©s de gÃ©nÃ©rateurs (sans doublons)
    """
    # 1. JSON curriculum
    from backend.curriculum.loader import get_chapter_by_official_code
    chapter_info = get_chapter_by_official_code(code_officiel)
    json_generators = chapter_info.exercise_types if chapter_info else []
    
    # 2. Associations DB
    db = await get_database()
    collection = db["chapter_generator_associations"]
    
    db_associations = await collection.find({
        "code_officiel": code_officiel,
        "is_active": True
    }).to_list(length=100)
    
    db_generators = [assoc["generator_key"] for assoc in db_associations]
    
    # 3. Fusionner
    return list(set(json_generators + db_generators))

# Utiliser dans generate_exercise
@router.post("/generate", ...)
async def generate_exercise(request: ExerciseGenerateRequest):
    # ...
    
    # Au lieu de:
    # exercise_types_override = curriculum_chapter.exercise_types
    
    # Utiliser:
    merged_generators = await _get_merged_chapter_generators(request.code_officiel)
    exercise_types_override = merged_generators
    
    # ...
```

---

### 5. Frontend - Filtrage par grade

**Objectif**: Dans l'admin, afficher par dÃ©faut UNIQUEMENT les gÃ©nÃ©rateurs compatibles

**Fichier**: `frontend/src/components/admin/ChapterExercisesAdminPage.js`

```javascript
// Ã‰tat pour les gÃ©nÃ©rateurs
const [allGenerators, setAllGenerators] = useState([]);
const [compatibleGenerators, setCompatibleGenerators] = useState([]);
const [incompatibleGenerators, setIncompatibleGenerators] = useState([]);

// Charger tous les gÃ©nÃ©rateurs
useEffect(() => {
  const fetchGenerators = async () => {
    const response = await axios.get(`${BACKEND_URL}/api/v1/exercises/generators`);
    const generators = response.data.generators;
    
    setAllGenerators(generators);
    
    // Filtrer par grade du chapitre
    const chapterGrade = codeOfficiel.split('_')[0]; // "6e" depuis "6e_SP03"
    
    const compatible = generators.filter(gen =>
      gen.is_dynamic && 
      gen.supported_grades.includes(chapterGrade)
    );
    
    const incompatible = generators.filter(gen =>
      gen.is_dynamic && 
      !gen.supported_grades.includes(chapterGrade)
    );
    
    setCompatibleGenerators(compatible);
    setIncompatibleGenerators(incompatible);
  };
  
  fetchGenerators();
}, [codeOfficiel]);

// Affichage par dÃ©faut : compatibles uniquement
<div className="generators-list">
  <h3>GÃ©nÃ©rateurs compatibles avec {codeOfficiel.split('_')[0]}</h3>
  {compatibleGenerators.map(gen => (
    <div key={gen.key} className="generator-item">
      <span>{gen.label}</span>
      {currentGenerators.includes(gen.key) ? (
        <Badge>ActivÃ©</Badge>
      ) : (
        <Button onClick={() => handleAddGenerator(gen.key)}>
          Ajouter
        </Button>
      )}
    </div>
  ))}
  
  <Collapsible>
    <CollapsibleTrigger>
      <Button variant="ghost">Plus de choix ({incompatibleGenerators.length})</Button>
    </CollapsibleTrigger>
    <CollapsibleContent>
      {incompatibleGenerators.map(gen => (
        <TooltipProvider key={gen.key}>
          <Tooltip>
            <TooltipTrigger>
              <div className="generator-item opacity-50">
                <span>{gen.label}</span>
                <Button disabled>Incompatible</Button>
              </div>
            </TooltipTrigger>
            <TooltipContent>
              Compatible avec : {gen.supported_grades.join(', ')}
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      ))}
    </CollapsibleContent>
  </Collapsible>
</div>
```

---

### 6. Frontend - Modal "Ajouter un gÃ©nÃ©rateur"

**Composant**: `<AddGeneratorModal />`

```javascript
// frontend/src/components/admin/AddGeneratorModal.js

import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '../ui/dialog';
import { Button } from '../ui/button';
import { Badge } from '../ui/badge';
import { Check, AlertCircle } from 'lucide-react';
import axios from 'axios';

const AddGeneratorModal = ({ codeOfficiel, open, onClose, onSuccess }) => {
  const [generators, setGenerators] = useState([]);
  const [loading, setLoading] = useState(false);
  
  useEffect(() => {
    if (open) {
      fetchAvailableGenerators();
    }
  }, [open, codeOfficiel]);
  
  const fetchAvailableGenerators = async () => {
    setLoading(true);
    try {
      // 1. RÃ©cupÃ©rer tous les gÃ©nÃ©rateurs
      const allGensResponse = await axios.get(`${BACKEND_URL}/api/v1/exercises/generators`);
      const allGenerators = allGensResponse.data.generators;
      
      // 2. RÃ©cupÃ©rer les gÃ©nÃ©rateurs dÃ©jÃ  associÃ©s
      const currentGensResponse = await axios.get(`${BACKEND_URL}/api/v1/admin/chapters/${codeOfficiel}/generators`);
      const currentKeys = currentGensResponse.data.generators.map(g => g.key);
      
      // 3. Filtrer : dynamiques + compatibles + non dÃ©jÃ  associÃ©s
      const chapterGrade = codeOfficiel.split('_')[0];
      
      const available = allGenerators.filter(gen =>
        gen.is_dynamic &&
        gen.supported_grades.includes(chapterGrade) &&
        !currentKeys.includes(gen.key)
      );
      
      setGenerators(available);
    } catch (error) {
      console.error('Erreur chargement gÃ©nÃ©rateurs:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const handleAdd = async (generatorKey) => {
    try {
      await axios.post(`${BACKEND_URL}/api/v1/admin/chapters/${codeOfficiel}/generators`, {
        generator_key: generatorKey
      });
      
      toast({
        title: "GÃ©nÃ©rateur ajoutÃ©",
        description: `${generatorKey} a Ã©tÃ© associÃ© au chapitre ${codeOfficiel}`
      });
      
      onSuccess();
      onClose();
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible d'ajouter le gÃ©nÃ©rateur",
        variant: "destructive"
      });
    }
  };
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Ajouter un gÃ©nÃ©rateur Ã  {codeOfficiel}</DialogTitle>
        </DialogHeader>
        
        {loading ? (
          <div className="flex items-center justify-center p-8">
            <Loader2 className="h-8 w-8 animate-spin" />
          </div>
        ) : generators.length === 0 ? (
          <div className="p-8 text-center text-gray-500">
            <AlertCircle className="h-12 w-12 mx-auto mb-4" />
            <p>Aucun gÃ©nÃ©rateur compatible disponible</p>
            <p className="text-sm mt-2">Tous les gÃ©nÃ©rateurs sont dÃ©jÃ  associÃ©s ou incompatibles avec {codeOfficiel.split('_')[0]}.</p>
          </div>
        ) : (
          <div className="space-y-4">
            <p className="text-sm text-gray-600">
              {generators.length} gÃ©nÃ©rateur{generators.length > 1 ? 's' : ''} compatible{generators.length > 1 ? 's' : ''} disponible{generators.length > 1 ? 's' : ''}
            </p>
            
            {generators.map(gen => (
              <div key={gen.key} className="flex items-start gap-3 p-4 border rounded-lg hover:bg-gray-50">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="font-medium">{gen.label}</span>
                    {gen.tags?.includes('premium') && (
                      <Badge className="bg-purple-100 text-purple-800">PREMIUM</Badge>
                    )}
                    <Badge variant="outline">{gen.version}</Badge>
                  </div>
                  <p className="text-sm text-gray-600 mb-2">{gen.description}</p>
                  <div className="flex gap-2 text-xs text-gray-500">
                    <span>Niveaux: {gen.supported_grades.join(', ')}</span>
                    {gen.tags && gen.tags.length > 0 && (
                      <span>â€¢ Tags: {gen.tags.join(', ')}</span>
                    )}
                  </div>
                </div>
                <Button onClick={() => handleAdd(gen.key)} size="sm">
                  <Check className="h-4 w-4 mr-1" />
                  Ajouter
                </Button>
              </div>
            ))}
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
};

export default AddGeneratorModal;
```

---

## ğŸ§ª TESTS

### Test Backend - API generators

```python
# backend/tests/test_admin_generators.py

def test_list_generators_with_metadata():
    """VÃ©rifier que /generators renvoie toutes les mÃ©tadonnÃ©es."""
    response = client.get("/api/v1/exercises/generators")
    assert response.status_code == 200
    
    data = response.json()
    assert "generators" in data
    
    # VÃ©rifier structure
    for gen in data["generators"]:
        assert "key" in gen
        assert "label" in gen
        assert "is_dynamic" in gen
        assert "supported_grades" in gen
        assert isinstance(gen["supported_grades"], list)
        assert len(gen["supported_grades"]) > 0

def test_add_generator_to_chapter():
    """VÃ©rifier qu'on peut ajouter un gÃ©nÃ©rateur Ã  un chapitre."""
    response = client.post(
        "/api/v1/admin/chapters/6e_SP03/generators",
        json={"generator_key": "CALCUL_NOMBRES_V1"}
    )
    assert response.status_code == 200
    
    data = response.json()
    assert data["generator_key"] == "CALCUL_NOMBRES_V1"
    assert data["code_officiel"] == "6e_SP03"

def test_list_merged_generators():
    """VÃ©rifier la fusion JSON + DB."""
    # Ajouter un gÃ©nÃ©rateur via DB
    client.post(
        "/api/v1/admin/chapters/6e_SP03/generators",
        json={"generator_key": "CALCUL_NOMBRES_V1"}
    )
    
    # Lister
    response = client.get("/api/v1/admin/chapters/6e_SP03/generators")
    assert response.status_code == 200
    
    data = response.json()
    generators = data["generators"]
    
    # VÃ©rifier que CALCUL_NOMBRES_V1 est prÃ©sent
    keys = [g["key"] for g in generators]
    assert "CALCUL_NOMBRES_V1" in keys
    
    # VÃ©rifier la source
    calcul_gen = next(g for g in generators if g["key"] == "CALCUL_NOMBRES_V1")
    assert calcul_gen["source"] == "db"
```

---

## ğŸ“‹ CHECKLIST D'IMPLÃ‰MENTATION

### Backend

- [ ] Ã‰tendre `/api/v1/exercises/generators` avec `supported_grades`, `is_dynamic`, `tags`
- [ ] CrÃ©er model `ChapterGeneratorAssociation`
- [ ] CrÃ©er collection MongoDB `chapter_generator_associations`
- [ ] CrÃ©er endpoint POST `/api/v1/admin/chapters/{code}/generators`
- [ ] CrÃ©er endpoint DELETE `/api/v1/admin/chapters/{code}/generators/{key}`
- [ ] CrÃ©er endpoint GET `/api/v1/admin/chapters/{code}/generators`
- [ ] ImplÃ©menter fusion JSON + DB dans `_get_merged_chapter_generators()`
- [ ] Utiliser fusion dans `/generate`
- [ ] Tests unitaires (3 tests minimum)

### Frontend

- [ ] Charger gÃ©nÃ©rateurs depuis `/api/v1/exercises/generators`
- [ ] Filtrer par `supported_grades` selon le chapitre
- [ ] Afficher par dÃ©faut : compatibles uniquement
- [ ] Ajouter section "Plus de choix" (collapsible) avec incompatibles grisÃ©s
- [ ] CrÃ©er composant `AddGeneratorModal`
- [ ] ImplÃ©menter bouton "Ajouter un gÃ©nÃ©rateur"
- [ ] Afficher tooltips pour gÃ©nÃ©rateurs incompatibles
- [ ] GÃ©rer les appels POST/DELETE vers l'API admin

### Tests manuels

- [ ] Admin peut voir la liste des gÃ©nÃ©rateurs compatibles
- [ ] Admin peut ajouter un gÃ©nÃ©rateur en 2 clics
- [ ] GÃ©nÃ©rateur ajoutÃ© apparaÃ®t immÃ©diatement dans la liste
- [ ] GÃ©nÃ©rateur incompatible est grisÃ© + tooltip explicatif
- [ ] GÃ©nÃ©ration d'exercice utilise les gÃ©nÃ©rateurs fusionnÃ©s (JSON + DB)
- [ ] Pas d'erreur "chapitre incompatible" aprÃ¨s ajout

---

## ğŸš€ ORDRE D'IMPLÃ‰MENTATION RECOMMANDÃ‰

1. âœ… **Backend - API /generators** (30 min)
2. âœ… **Backend - Model + Collection** (15 min)
3. âœ… **Backend - Endpoints admin** (1h)
4. âœ… **Backend - Fusion JSON + DB** (30 min)
5. âœ… **Tests backend** (30 min)
6. âœ… **Frontend - Filtrage** (45 min)
7. âœ… **Frontend - Modal** (1h)
8. âœ… **Tests manuels** (30 min)

**Temps total estimÃ©**: **4-5 heures**

---

## ğŸ’¡ AVANTAGES DE CETTE APPROCHE

### Pour l'admin

- âœ… **ZÃ©ro erreur Ã©vitable** : filtrage automatique par grade
- âœ… **Ajout guidÃ©** : modal claire avec seulement les compatibles
- âœ… **Pas de JSON** : ajout en 2 clics via UI
- âœ… **RÃ©versible** : soft delete, on peut revenir en arriÃ¨re
- âœ… **SÃ©curisÃ©** : validation backend + frontend

### Pour le systÃ¨me

- âœ… **Compat legacy** : JSON curriculum reste la source de vÃ©ritÃ© par dÃ©faut
- âœ… **Extensible** : ajout facile de nouveaux gÃ©nÃ©rateurs via UI
- âœ… **TraÃ§able** : chaque association a un `added_by` + `added_at`
- âœ… **Performant** : fusion en mÃ©moire, pas de requÃªte DB coÃ»teuse

### Pour les dÃ©veloppeurs

- âœ… **Pas de migration** : JSON existant reste valide
- âœ… **Progressif** : peut rester 100% JSON ou migrer vers DB
- âœ… **Testable** : endpoints admin sÃ©parÃ©s, faciles Ã  tester
- âœ… **Maintenable** : logique claire, responsabilitÃ©s sÃ©parÃ©es

---

## ğŸ“Š DIAGRAMME FLUX

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ADMIN ouvre page gestion chapitre 6e_SP03             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend charge :                                      â”‚
â”‚  - /api/v1/exercises/generators (tous avec metadata)   â”‚
â”‚  - /api/v1/admin/chapters/6e_SP03/generators (actuels) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Filtrage automatique :                                 â”‚
â”‚  - Compatible = is_dynamic & supported_grades="6e"      â”‚
â”‚  - Incompatible = autres niveaux                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Affichage UI :                                         â”‚
â”‚  - Par dÃ©faut : compatibles (+ badge "ActivÃ©/Ajouter")â”‚
â”‚  - "Plus de choix" : incompatibles grisÃ©s + tooltip    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ADMIN clique "Ajouter un gÃ©nÃ©rateur"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Modal liste :                                          â”‚
â”‚  - GÃ©nÃ©rateurs compatibles NON dÃ©jÃ  associÃ©s           â”‚
â”‚  - Bouton "Ajouter" pour chaque                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ADMIN sÃ©lectionne CALCUL_NOMBRES_V1                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend POST /admin/chapters/6e_SP03/generators       â”‚
â”‚  Body: {"generator_key": "CALCUL_NOMBRES_V1"}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend :                                              â”‚
â”‚  1. VÃ©rifie que gÃ©nÃ©rateur existe                       â”‚
â”‚  2. CrÃ©e association en DB                              â”‚
â”‚  3. Retourne succÃ¨s                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend rafraÃ®chit la liste                           â”‚
â”‚  CALCUL_NOMBRES_V1 apparaÃ®t avec badge "ActivÃ©"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ENSUITE : GÃ©nÃ©ration d'exercice                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/exercises/generate                        â”‚
â”‚  Body: {"code_officiel": "6e_SP03", ...}               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend _get_merged_chapter_generators("6e_SP03") :    â”‚
â”‚  1. Charge JSON curriculum (ex: [RAISONNEMENT_...])    â”‚
â”‚  2. Charge associations DB (ex: [CALCUL_NOMBRES_V1])   â”‚
â”‚  3. Fusionne : [RAISONNEMENT_..., CALCUL_NOMBRES_V1]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GÃ©nÃ©ration utilise les 2 gÃ©nÃ©rateurs disponibles       â”‚
â”‚  Premium dispatch peut choisir l'un ou l'autre          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**PrÃªt pour l'implÃ©mentation** âœ…

**Prochaine Ã©tape** : Commencer par le backend (API /generators + endpoints admin)





